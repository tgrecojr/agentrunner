# ============================================
# Multi-Agent Orchestration Platform
# AgentOrchestrator Service Dockerfile
# ============================================

# Use the base image
FROM python:3.11-slim as base

# Set working directory
WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements
COPY requirements.txt requirements-dev.txt ./

# Install Python dependencies
RUN pip install --no-cache-dir -r requirements.txt

# ============================================
# Runtime Stage
# ============================================
FROM base as runtime

# Set working directory
WORKDIR /app

# Copy application code
COPY src/ ./src/
COPY .env.example ./.env

# Create config directory for volume mount
RUN mkdir -p /app/config/agents

# Create entrypoint script
RUN echo '#!/bin/bash\n\
set -e\n\
\n\
echo "Starting AgentOrchestrator..."\n\
\n\
# Wait for dependencies\n\
echo "Waiting for dependencies..."\n\
\n\
# Wait for StateManager\n\
until curl -f http://${STATE_MANAGER_HOST:-state-manager}:${STATE_MANAGER_PORT:-8001}/health/live 2>/dev/null; do\n\
  echo "StateManager is unavailable - sleeping"\n\
  sleep 2\n\
done\n\
echo "StateManager is up!"\n\
\n\
# Wait for ConfigService\n\
until curl -f http://${CONFIG_SERVICE_HOST:-config-service}:${CONFIG_SERVICE_PORT:-8002}/health/live 2>/dev/null; do\n\
  echo "ConfigService is unavailable - sleeping"\n\
  sleep 2\n\
done\n\
echo "ConfigService is up!"\n\
\n\
# Wait for RabbitMQ\n\
until curl -f http://${RABBITMQ_HOST:-rabbitmq}:15672/api/healthchecks/node 2>/dev/null; do\n\
  echo "RabbitMQ is unavailable - sleeping"\n\
  sleep 2\n\
done\n\
echo "RabbitMQ is up!"\n\
\n\
# Verify config directory is accessible\n\
if [ ! -d "/app/config/agents" ]; then\n\
  echo "WARNING: Config directory /app/config/agents not found!"\n\
  echo "Creating empty config directory..."\n\
  mkdir -p /app/config/agents\n\
fi\n\
\n\
echo "Configuration directory: /app/config/agents"\n\
echo "Found $(ls -1 /app/config/agents/*.yaml 2>/dev/null | wc -l) YAML configuration files"\n\
\n\
# Start the API server\n\
echo "Starting AgentOrchestrator API server..."\n\
exec uvicorn src.orchestrator.api:app \\\n\
  --host ${ORCHESTRATOR_HOST:-0.0.0.0} \\\n\
  --port ${ORCHESTRATOR_PORT:-8003} \\\n\
  --workers ${API_WORKERS:-2} \\\n\
  --log-level ${LOG_LEVEL:-info}\n\
' > /app/entrypoint.sh && chmod +x /app/entrypoint.sh

# Expose port
EXPOSE 8003

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
  CMD curl -f http://localhost:8003/health/live || exit 1

# Volume for configuration files (shared with config-service)
VOLUME ["/app/config/agents"]

# Set entrypoint
ENTRYPOINT ["/app/entrypoint.sh"]
