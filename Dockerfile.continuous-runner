# ============================================
# Multi-Agent Orchestration Platform
# Continuous Agent Runner Dockerfile
# ============================================

# Use the base image
FROM python:3.11-slim as base

# Set working directory
WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements
COPY requirements.txt requirements-dev.txt ./

# Install Python dependencies including Portia AI SDK
RUN pip install --no-cache-dir -r requirements.txt

# ============================================
# Runtime Stage
# ============================================
FROM base as runtime

# Set working directory
WORKDIR /app

# Copy application code
COPY src/ ./src/
COPY .env.example ./.env

# Create entrypoint script
RUN echo '#!/bin/bash\n\
set -e\n\
\n\
echo "Starting Continuous Agent Runner..."\n\
\n\
# Wait for dependencies\n\
echo "Waiting for dependencies..."\n\
\n\
# Wait for StateManager\n\
until curl -f http://${STATE_MANAGER_HOST:-state-manager}:${STATE_MANAGER_PORT:-8001}/health/live 2>/dev/null; do\n\
  echo "StateManager is unavailable - sleeping"\n\
  sleep 2\n\
done\n\
echo "StateManager is up!"\n\
\n\
# Wait for ConfigService\n\
until curl -f http://${CONFIG_SERVICE_HOST:-config-service}:${CONFIG_SERVICE_PORT:-8002}/health/live 2>/dev/null; do\n\
  echo "ConfigService is unavailable - sleeping"\n\
  sleep 2\n\
done\n\
echo "ConfigService is up!"\n\
\n\
# Wait for RabbitMQ\n\
until curl -f http://${RABBITMQ_HOST:-rabbitmq}:15672/api/healthchecks/node 2>/dev/null; do\n\
  echo "RabbitMQ is unavailable - sleeping"\n\
  sleep 2\n\
done\n\
echo "RabbitMQ is up!"\n\
\n\
# Wait for AgentOrchestrator\n\
until curl -f http://${ORCHESTRATOR_HOST:-agent-orchestrator}:${ORCHESTRATOR_PORT:-8003}/health/live 2>/dev/null; do\n\
  echo "AgentOrchestrator is unavailable - sleeping"\n\
  sleep 2\n\
done\n\
echo "AgentOrchestrator is up!"\n\
\n\
echo "All dependencies are ready!"\n\
\n\
# Start the Continuous Agent Runner\n\
echo "Starting Continuous Agent Runner worker..."\n\
exec python -m src.agents.continuous_agent_runner\n\
' > /app/entrypoint.sh && chmod +x /app/entrypoint.sh

# Health check - verifies the process is running
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
  CMD ps aux | grep -v grep | grep continuous_agent_runner || exit 1

# Set entrypoint
ENTRYPOINT ["/app/entrypoint.sh"]
