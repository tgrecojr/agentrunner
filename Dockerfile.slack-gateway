# ============================================
# Multi-Agent Orchestration Platform
# Slack Gateway Dockerfile
# ============================================

# Use the base image
FROM python:3.11-slim as base

# Set working directory
WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements
COPY requirements.txt requirements-dev.txt ./

# Install Python dependencies
RUN pip install --no-cache-dir -r requirements.txt

# ============================================
# Runtime Stage
# ============================================
FROM base as runtime

# Set working directory
WORKDIR /app

# Copy application code
COPY src/ ./src/
COPY .env.example ./.env

# Create entrypoint script
RUN echo '#!/bin/bash\n\
set -e\n\
\n\
echo "Starting Slack Gateway..."\n\
\n\
# Wait for dependencies\n\
echo "Waiting for dependencies..."\n\
\n\
# Wait for RabbitMQ\n\
until curl -f http://${RABBITMQ_HOST:-rabbitmq}:15672/api/healthchecks/node 2>/dev/null; do\n\
  echo "RabbitMQ is unavailable - sleeping"\n\
  sleep 2\n\
done\n\
echo "RabbitMQ is up!"\n\
\n\
echo "All dependencies are ready!"\n\
\n\
# Start the Slack Gateway API\n\
echo "Starting Slack Gateway API on port 8005..."\n\
exec python -m uvicorn src.integrations.api:app --host 0.0.0.0 --port 8005\n\
' > /app/entrypoint.sh && chmod +x /app/entrypoint.sh

# Expose port
EXPOSE 8005

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
  CMD curl -f http://localhost:8005/health/live || exit 1

# Set entrypoint
ENTRYPOINT ["/app/entrypoint.sh"]
