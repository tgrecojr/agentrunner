# ============================================
# Multi-Agent Orchestration Platform
# ConfigurationService Dockerfile
# ============================================

# Use the base image
FROM python:3.11-slim as base

# Set working directory
WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements
COPY requirements.txt requirements-dev.txt ./

# Install Python dependencies
RUN pip install --no-cache-dir -r requirements.txt

# ============================================
# Runtime Stage
# ============================================
FROM base as runtime

# Set working directory
WORKDIR /app

# Copy application code
COPY src/ ./src/
COPY .env.example ./.env

# Create config directory for volume mount
RUN mkdir -p /app/config/agents

# Create entrypoint script
RUN echo '#!/bin/bash\n\
set -e\n\
\n\
echo "Starting ConfigurationService..."\n\
\n\
# Verify config directory is accessible\n\
if [ ! -d "/app/config/agents" ]; then\n\
  echo "WARNING: Config directory /app/config/agents not found!"\n\
  echo "Creating empty config directory..."\n\
  mkdir -p /app/config/agents\n\
fi\n\
\n\
echo "Configuration directory: /app/config/agents"\n\
echo "Found $(ls -1 /app/config/agents/*.yaml 2>/dev/null | wc -l) YAML configuration files"\n\
\n\
# Start the API server\n\
echo "Starting ConfigurationService API server..."\n\
exec uvicorn src.config.api:app \\\n\
  --host ${CONFIG_SERVICE_HOST:-0.0.0.0} \\\n\
  --port ${CONFIG_SERVICE_PORT:-8002} \\\n\
  --workers ${API_WORKERS:-2} \\\n\
  --log-level ${LOG_LEVEL:-info}\n\
' > /app/entrypoint.sh && chmod +x /app/entrypoint.sh

# Expose port
EXPOSE 8002

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=20s --retries=3 \
  CMD curl -f http://localhost:8002/health/live || exit 1

# Volume for configuration files (mount as read-only in docker-compose)
VOLUME ["/app/config/agents"]

# Set entrypoint
ENTRYPOINT ["/app/entrypoint.sh"]
